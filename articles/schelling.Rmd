---
title: "The Schelling Model of Segregation"
output: distill::distill_article
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(gganimate)
library(dplyr)
library(gridabm)
set.seed(420)
```


The Schelling model of segregation [@schelling1971segregation] is a famous agent-based model (ABM) that addresses ethnic segregation in urban areas.

The model yielded some pretty surprising results and they will make clear what the intent of an agent-based model is.

The constituents of the model are:

#### An Environment

The environment is the "arena" in which the agents interact with one another.
In the Schelling model, we use a square grid:

```{r}
matrix(0, nrow = 20, ncol = 20) %>% 
  plot_state(5, c("white"))
```

#### Agents

The agents are the individuals that interact in the arena.
In this case, we have two different kinds of agents that we distribute across the grid.
Let's call them blue and orange agents.
Note that we don't fill the grid completely, there are empty cells left.

```{r}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
plot_state(init_board, 5, theme_schelling())
```

Additionally to having a position in the environment, agents can have states or attributes.
Here each agents is either *happy* or *unhappy*.


#### Rules

The rules define how agents interact with one another as well as with the environment.
In the Schelling model, the rules are as follows:

* There is a global **tolerance** level which indicates, how many agents of the same kind any agent wishes to live next to.
* If the number of neighbors of the other kind (i.e., blue if an agent is orange and vice versa) is higher than the tolerance level allows, an agent is unhappy, otherwise it is happy.
* The model is played in iterations (sometimes called steps, ticks, time steps, ...). In each iteration, each agent's mood is determined (happy or unhappy). Agents that are unhappy move to a random free cell.


Environment, agents, and rules are the three essential ingredients for any ABM.



The neighborhood is defined as the eight cells around the cell that an agents sits on (the [**Moore neighborhood**](.)).
[TODO: add link once article done]


```{r}
m <- matrix(0, ncol = 9, nrow = 9)
m[5, 5] <- 2
neighbors <- get_moore_neighborhood(5, 5, 9)
for (n in neighbors) {
  m[n[1], n[2]] <- 1
}
m %>% 
  plot_state(12, c("white", "grey80", "grey20")) +
  labs(
    title = "Moore neighborhood",
    caption = "The Moore neighborhood of the (darker) cell in the center."
  )
```




## Running the Model

Now that we have the setup down, let's look at a simple example.
We randomly draw distribute 45% blue agents, 45% orange agents, and 10% free cells over the board.
The tolerance level is set to 3, meaning that each agent will turn unhappy if it has more than 3 neighbors that are not of its own kind.

```{r}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
schelling <- run_automaton(init_board, 100, schelling_step, tolerance = 3)
anim <- schelling %>%
  animate_model_run(5, theme_schelling()) +
  labs(title = "Step: {closest_state}")
animate(anim, nframes = 200, renderer = gifski_renderer())
```



#### Task

There is a free implementation of Schelling's model of segregation [@wilensky1997segretation] in the NetLogo [@wilensky1999netlogo] library.
Open it and play around with the parameters.
Can you observe some general tendencies of what happens?



## Manipulating the `tolerance` parameter

In the example above, we already saw that with a tolerance level of $3$, the segregate into clusters of alike agents.
What would you expect to happen for higher or lower tolerance thresholds?

```{r, fig.width=12, fig.height=12}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
d <- data.frame()
for (tol in seq(0, 8)) {
  res_tmp <- run_automaton(init_board, 100, schelling_step, tolerance = tol)
  res_tmp$tol <- tol
  d <- bind_rows(d, res_tmp)
}
anim <- d %>% 
  animate_model_run(0.7, theme_schelling()) +
  facet_wrap(. ~ tol, nrow = 3, strip.position = "left") +
  theme(
    strip.background = element_rect(fill = "white", color = "transparent"),
    strip.text.y = element_text(color = "black", angle = 90)
  ) +
  labs(title = "Step: {closest_state}")
animate(anim, nframes = 200, renderer = gifski_renderer())
```





