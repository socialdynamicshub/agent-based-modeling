---
title: "The Schelling Model of Segregation"
output: distill::distill_article
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(gganimate)
library(dplyr)
source("./helpers/board_to_df.R")
source("./helpers/get_moore_neighborhood.R")
source("./helpers/schelling.R")
source("./helpers/grid_plot.R")
set.seed(420)
```


The Schelling model of segregation [@schelling1971segregation] is a famous agent-based model (ABM) and it is one of the first that got a lot of attention.
It addresses the tendency of ethnic segregation in urban areas.

The model yielded some pretty surprising results and they will make clear what the intent of an agent-based model is.

The constituents of the model are:

#### An Environment

The environment is the "arena" in which the agents interact with one another.
In the Schelling model, we use a square grid:

```{r}
axis_size <- 20
board <- matrix(0, nrow = axis_size, ncol = axis_size)
df <- board_to_df(board)
df$cell_id <- as.factor(1:nrow(df))
color_scheme <- c(`0` = "white")
grid_plot(df, 5, color_scheme)
```

#### Agents

The agents are the individuals that interact in the arena.
In this case, we have two different kinds of agents that we distribute across the grid.
Let's call them blue and orange agents.
Note that we don't fill the grid completely, there are empty cells left.

```{r}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
df <- board_to_df(init_board)
df$cell_id <- as.factor(1:nrow(df))
color_scheme <- c(`0` = "white", `1` = "orange", `2` = "blue")
grid_plot(df, 5, color_scheme)
```

Additionally to having a position in the environment, agents can have states or attributes.
Here each agents is either *happy* or *unhappy*.


#### Rules

The rules define how agents interact with one another as well as with the environment.
In the Schelling model, the rules are as follows:

* There is a global **tolerance** level which indicates, how many agents of the same kind any agent wishes to live next to.
* If the number of neighbors of the other kind (i.e., blue if an agent is orange and vice versa) is higher than the tolerance level allows, an agent is unhappy, otherwise it is happy.
* The model is played in iterations (sometimes called steps, ticks, time steps, ...). In each iteration, each agent's mood is determined (happy or unhappy). Agents that are unhappy move to a random free cell.


Environment, agents, and rules are the three essential ingredients for any ABM.



The neighborhood is defined as the eight cells around the cell that an agents sits on (the [**Moore neighborhood**](.)).
[TODO: add link once article done]


[GRAPHIC FOR NEIGHBORHOOD]




#### Running the Model

Now that we have the setup down, let's look at a simple example.
We randomly draw distribute 40% blue agents, 40% orange agents, and 20% free cells over the board.
The tolerance level is set to 3, meaning that each agent prefers 4 or more agents of its own kind in its neighborhood.
This is what happens:

```{r}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
tolerance <- 3
schelling <- schelling_game(init_board, tolerance, 100)

color_scheme <- c(`0` = "white", `1` = "orange", `2` = "blue")

anim <- schelling %>%
  grid_plot(5, color_scheme) +
  transition_states(step, transition_length = 1, state_length = 10) +
  labs(title = "Step: {closest_state}")

animate(anim, nframes = 200, renderer = gifski_renderer())
```





#### Task

There is a free implementation of Schelling's model of segregation [@wilensky1997segretation] in the NetLogo [@wilensky1999netlogo] library.
Open it and play around with the parameters.
Can you observe some general tendencies of what happens?


```{r}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
param_levels <- seq(0, 8)
schelling_multi <- schelling_game_multi(init_board, param_levels, 100)

color_scheme <- c(`0` = "white", `1` = "orange", `2` = "blue")

anim <- schelling_multi %>% 
  grid_plot(1, color_scheme) +
  facet_wrap(. ~ tolerance, nrow = 3, strip.position = "left") +
  theme(
    strip.background = element_rect(fill = "white", color = "transparent"),
    strip.text = element_text(color = "black", angle = 90)
  ) +
  transition_states(step, transition_length = 1, state_length = 10) +
  labs(title = "Step: {closest_state}")

animate(anim, nframes = 200, renderer = gifski_renderer())
```





