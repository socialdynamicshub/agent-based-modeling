---
title: "The Schelling Model of Segregation"
output: distill::distill_article
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(gganimate)
library(dplyr)
source("./helpers/board_to_df.R")
source("./helpers/get_moore_neighborhood.R")
source("./helpers/schelling.R")
set.seed(420)
```


The Schelling model of segregation [@schelling1971segregation] is a famous agent-based model (ABM) and it is also one of the first that got a lot of attention.
It addresses the tendency of ethnic segregation in urban areas.

The model yielded some pretty surprising results and they will make clear what the intent of an agent-based model is.

The constituents of the model are:

* a "world" which is just a square grid (think chess board)
* agents of two different kinds (let's call them blue and orange agents)
* rules of how to displace agents (they "move to a different neighborhood" if they don't feel comfortable)

These are, coincidentally (although, of course, not so much so), the three fundamental ingredients of agent-based models in general.

```{r}
axis_size <- 10

df <- data.frame(
  x = rep(seq(1, axis_size), each = axis_size),
  y = rep(seq(1, axis_size), times = axis_size),
  state = sample(c("blue", "orange", "empty"), prob = c(0.4, 0.4, 0.2), replace = TRUE, axis_size^2)
)

color_scheme <- c("blue" = "blue", "orange" = "orange", "empty" = "transparent")

df %>% 
  ggplot(aes(x = x, y = y, fill = state)) +
  geom_point(size = 13, shape = 22, color = "transparent") +
  scale_fill_manual(values = color_scheme) +
  coord_fixed() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "none",
    panel.background = element_rect(fill = "white"),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = "transparent", color = "darkgrey", size = 3),
  ) +
  NULL
```


The world and the agents are relatively self-explanatory, but what about the rules?

Rules in an ABM determine how agents interact with other agents or their environment.
They define the "behavior" of the agents, if you will.

In the Schelling model, agents have an attribute: They are either happy or unhappy.
What determines their happiness is a global "tolerance" threshold which determines how many agents of the other kind they tolerate in their neighborhood (i.e., if they are blue agents, how many orange agents they accept to live next to).
The neighborhood is defined as the eight cells around the cell that an agents sits on (the [**Moore neighborhood**](.)).
[TODO: add link once article done]

[GRAPHIC FOR NEIGHBORHOOD]

[...SOME MORE ELABORATION]


Let's look at a simple example.
Here, we have about 40% blue agents, 40% orange agents, and 20% free cells.
The tolerance level is set to 4, meaning that each agent prefers 4 or more agents of its own kind in its neighborhood.

```{r}
init_board <- matrix(
  sample(c(0, 1, 2), replace = TRUE, prob = c(0.1, 0.45, 0.45), size = 400),
  ncol = 20, nrow = 20
)
tolerance <- 4
schelling <- schelling_game(init_board, tolerance, 300)

color_scheme <- c(`0` = "white", `1` = "orange", `2` = "blue")

anim <- schelling %>%
  ggplot(aes(x = x, y = y, fill = state)) +
  geom_point(size = 5, shape = 22, color = "transparent") +
  scale_fill_manual(values = color_scheme) +
  scale_x_continuous(minor_breaks = seq(0.5, 19.5, 1), breaks = seq(0, 20)) +
  scale_y_continuous(trans = "reverse", minor_breaks = seq(0.5, 19.5, 1), breaks = seq(0, 20)) +
  transition_states(step, transition_length = 1, state_length = 1) +
  coord_fixed() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "none",
    panel.background = element_rect(fill = "transparent") ,
    panel.grid.minor = element_line(color = "lightgrey"),
    panel.grid.major = element_line(color = "transparent"),
    panel.border = element_rect(fill = "transparent", color = "darkgrey", size = 3)
  )

animate(anim, nframes = 400, renderer = av_renderer())
```



#### Task

There is a free implementation of Schelling's model of segregation [@wilensky1997segretation] in the NetLogo [@wilensky1999netlogo] library.
Open it and play around with the parameters.
Can you observe some general tendencies of what happens?







